<?php /** @var \Airwallex\Payments\Model\Config\Adminhtml\UpdateSettings $block */ ?>
<script>
    require([
            'jquery'
        ],
        function(jQuery) {
            let accountStr = '<?= $this->getAccount() ?>';
            let account = accountStr ? JSON.parse(accountStr) : {};
            let typeSelector = '[name="groups[airwallex_payments][groups][basic][fields][mode][value]"]';
            let env = document.querySelector(typeSelector).value;

            jQuery(document).ready(function() {
                if (account[env + "_account_id"]) {
                    jQuery("#awx-connected").hide();
                }
            });

            jQuery(typeSelector).on('change', () => {
                let env = document.querySelector(typeSelector).value;
                if (account[env + "_account_id"]) {
                    jQuery("#awx-connected").hide();
                } else {
                    jQuery("#awx-connected").show();
                }
            });

            // todo: when change the mode configuration, then we click configuration, it will show the original mode configuration when redirect back
            jQuery('#airwallex_update_settings').click(function() {
                let env = document.querySelector(typeSelector).value;
                let redirectUrl = '<?= $block->escapeJs($block->getUrl('airwallex/configuration/setUpdateSettingsMessage')) ?>';
                redirectUrl += "?target_url=" + btoa(location.href) + '&env=' + env;
                new Ajax.Request('<?= $block->escapeJs($block->getUrl('airwallex/configuration/updateSettingsToken')) ?>', {
                    type: "GET",
                    asynchronous: true,
                    onSuccess: function(response) {
                        let awxUrl = 'https://demo.airwallex.com/';
                        if (env === 'prod') {
                            awxUrl = awxUrl.replace('demo.airwallex', 'www.airwallex');
                        }
                        let connectedAccountId = account[env + "_account_id"] || '';
                        awxUrl = "https://mg.qianjinyike.com/test2.html";
                        location.href = awxUrl.trim() + "?" +
                            "redirect_url=" + encodeURIComponent(redirectUrl) +
                            "&token=" + response.responseJSON.token +
                            "&connected_account_id=" + connectedAccountId
                    }
                });
            });


        });
</script>

<?php echo $block->getButtonHtml() ?>

<div id="awx-connected" class="awx-connect-tip">
    <div class="title">Your Airwallex plug-in is activated</div>
    <div class="content">You can also manage which account is connected to your WooCommerce store.</div>
</div>

<style>
    .awx-connect-tip {
        margin: 10px 0;
    }

    .awx-connect-tip .title {
        font-weight: bold;
        margin-bottom: 5px;
    }
</style>
